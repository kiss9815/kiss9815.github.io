---
title: "[ORACLE] hash join 이란"
categories:
  - tuning
tags:
  - hash join
last_modified_at: 2019-01-03T13:00:00+09:00
toc: true
toc_sticky: true
---

## hash join  [해쉬조인]이란
해시 조인(Hash-Join)은 두 테이블 중 하나를 기준으로 __비트맵 해시 테이블을 메모리__ 에 올린 후 나머지 테이블을 스캔 하면서 해싱 테이블을 적용하여 __메모리에 로딩된 테이블과 비교하여 매칭되는 데이터를 추출__ 하는 방식의 조인이다.
RDBMS에 서 비용이 가장 많이 들어가는 Join 방법으로 주로 __작은 Table과 큰 Table 의 Join__ 시 사용되어 지며 , Driving 조건과 상관없이 좋은 성능을 발휘할 수 있다.

## 순서
1. __작은 테이블(Build Input)을 읽어 Hash Area에 해시 테이블 생성__ 한다.
(해시 함수에서 리턴 받은 버킷 주소로 찾아가 해시 체인에 엔트리를 연결)
2. 큰테이블 집합(Probe Input)을 읽어 해시 테이블을 탐색하면서 조인하는 방식이다.
(해시 함수에서 리턴 받은 버킷 주소로 찾아가 해시 체인을 스캔하면서 데이터를 찾는다)

## 특징
- 해시 조인은 안티 조인과 병렬처리와 잘 맞으며 범위 검색(Range scan)이 아닌 동등 비교(Equi-Join, where절에서 등호로 비교하는 경우)에 더 적합하다.
-	NL조인 과 달리 Random 액세스 부하가 없다.(단, 양쪽집합을 읽는 과정에서 인덱스를 이용한다면 Random 액세스 발생)
- NL조인 과 달리 Hash Area에 미리 생성해 둔 해시 테이블(또는 해시 맵)을 이용한다.
(해시테이블을 만드는 단계는 전체범위처리 불가피, Probe Input을 스캔하는 단계는 NL조인처럼 부분범위처리가능)
- 소트머지조인과 달리 조인 전에 미리 양쪽 집합을 정렬하는 부담이 없으며 NL조인 과 달리 래치획득 과정없이 PGA에서 빠르게 데이터 탐색한다.
- 해시 테이블을 생성하는 비용이 수반됨으로 Build Input이 작을때 효과적이며 PGA(or SGA) 메모리에 할당되는 Hash Area에 담길 정도로 충분히 작아야 한다. 해시키 값으로 사용되는 컬럼에 중복값이 거의 없을 때 효과적이다.
- SQL 문장에서 옵티마이저는 해쉬 조인으로 수행하기 위해 작은 테이블을 메모리에 로드 한 후 큰 테이블을 여러 Partition으로 분리하여 메모리에 로드가 되어 있는 작은 테이블을 해쉬 알고리즘에 의하여 탐색하게 되고 여러 Partition 으로 나뉘어 지는 테이블은 HASH_AREA_SIZE 에 명시된 메모리에 상주되며 메모리가 충분치 않아 메모리에 모두 상주 시킬수 있는 상황이라면 디스크에 위치하게 된다. (충분한 hash_area_size 제공필요)
- 해시조인을 사용하기 위해서는 USE_HASH hint를 사용 한다.
- CPU 성능에 의존적
- 대용량 처리의 선결조건인 랜덤 액세스와 정렬에 대한 부담을 해결할 수 있는 대안
- parallel processing을 이용한 hash 조인은 대용량 데이터를 처리하기 위한 최적의 솔루션

## 사용시 주의사항
1. 한쪽 테이블이 Hash Area에 담길 정도로 충분히 작아야함. -> 메모리의 지나친 사용으로 오버헤드 발생 가능성
2. Build Input 해시 키 컬럼에 중복 값이 거의 없어야 함.
3. 조인 컬럼에 적당한 인덱스가 없어 NL조인이 비효율적일때
4. 조인 컬럼에 인덱스가 있더라고 NL 조인 드라이빙 집합에서 Inner 쪽 집합으로서의 조인 액세스량이 많아 Random 액세스 부하가 심할 때
5. 소트 머지 조인하기에는 두 테이블이 너무 커 소트 부하가 심할때
6. 수행빈도가 낮고 쿼리 수행 시간이 오래 걸리는 대용량 테이블을 조인할때
7. 연결조건 연산자가 ‘=’인 동치조인인 경우에만 가능

## 참고
해시테이블은 단 하나의 쿼리를 위해 생성하고 조인이 끝나면 곧바로 소멸하는 자료구조


## 결론
해시테이블을 생성해서 메모리를 차지하는 실행계획이므로 빈번한 쿼리에는 사용하지 않고, 대용량 배치 및 통계쿼리에나 사용하자.
sort Merge 와 NL 의 중간정도 가는 성능.


참고문헌
> http://ojc.asia/bbs/board.php?bo_table=LecHINT&wr_id=127
> https://needjarvis.tistory.com/162
> http://www.jidum.com/jidums/view.do?jidumId=167
